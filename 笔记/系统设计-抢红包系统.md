2025-12-06 15:41
Status: #idea
Tags: [[系统设计]]

## 0.1 抢红包系统设计
### 0.1.1 背景
和秒杀类型，抢红包也是读多写少。
抢红包有 3 个核心流程：**红包金额拆分->抢红包->打款**。

包红包、发红包、抢红包、拆红包
红包过期退款
难点分析：
- 不能超发
- 支持高并发：1亿用户抢红包
- 红包金额什么时候算、怎么算
- 打款

### 0.1.2 红包表结构
红包主表：
```sql
CREATE TABLE `t_redpack_activity`
(
    `id`         bigint(20)     NOT NULL COMMENT '主键',
    `total_amount`     decimal(10, 2) NOT NULL DEFAULT '0.00' COMMENT '总金额',
    `surplus_amount`     decimal(10, 2) NOT NULL DEFAULT '0.00' COMMENT '剩余金额',
    `total` bigint(20)     NOT NULL DEFAULT '0' COMMENT '红包总数',
    `surplus_total` bigint(20)     NOT NULL DEFAULT '0' COMMENT '红包剩余总数',
    `user_id`    bigint(20)     NOT NULL DEFAULT '0' COMMENT '用户编号',
    `version` bigint(20)     NOT NULL DEFAULT '0' COMMENT '版本号',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
```

子红包表：
```sql
CREATE TABLE `t_redpack`
(
    `id`         bigint(20)     NOT NULL COMMENT '主键',
    `activity_id`         bigint(20)     NOT NULL DEFAULT 0 COMMENT '红包活动ID',
    `amount`     decimal(10, 2) NOT NULL DEFAULT '0.00' COMMENT '金额',
    `status`     TINYINT(4) NOT NULL DEFAULT 0 COMMENT '红包状态 1可用 2不可用',
    `version` bigint(20)     NOT NULL DEFAULT '0' COMMENT '版本号',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
```

抢红包明细表：
```sql
CREATE TABLE `t_redpack_detail`
(
    `id`         bigint(20)     NOT NULL COMMENT '主键',
    `amount`     decimal(10, 2) NOT NULL DEFAULT '0.00' COMMENT '金额',
    `user_id`    bigint(20)     NOT NULL DEFAULT '0' COMMENT '用户编号',
    `redpack_id` bigint(20)     NOT NULL DEFAULT '0' COMMENT '红包编号',
    `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
```

因为有了抢红包明细表，所以用户查询红包记录就可以用这个表。
而红包表就可以跳过分库分表拆分。

### 0.1.3 数据库方案
#### 0.1.3.1 发红包流程
![[image-137.png]]

#### 0.1.3.2 抢红包流程
![[image-138.png]]

### 0.1.4 缓存方案
#### 0.1.4.1 发红包流程
![[image-139.png]]

#### 0.1.4.2 抢红包流程
![[image-140.png]]

### 0.1.5 SET化方案
![[image-143.png]]

![[image-144.png]]
![[image-145.png]]

### 0.1.6 拆分方案
#### 0.1.6.1 实时拆分
实时拆分，指的是在**抢红包时实时计算**每个红包的金额，以实现红包的拆分过程，对系统性能和拆分算法要求较高，例如拆分过程要一直保证后续待拆分红包的金额不能为空，不容易做到拆分的红包金额服从正态分布规律。

![[image-148.png]]

#### 0.1.6.2 预先生成
预先生成，指的是在红包**开抢之前**已经完成了红包的**金额拆分**，抢红包时只是依次取出拆分好的红包金额，对拆分算法要求较低，可以拆分出随机性很好的红包金额，通常需要结合队列使用。

通常使用 **二倍均值法** 的算法拆分红包金额。拆分算法可以描述为：假设剩余拆分金额为 M，剩余待拆分红包个数为 N，红包最小金额为 1 元，那么定义当前红包的金额为：
```go
m=rand(1,floor(M/N∗2))
```
因为 N >= 2，所以 M/N\*2 <= M，表示一定能保证后续红包能拆分到金额。

![[image-146.png]]

![[image-147.png]]

### 0.1.7 限流
和秒杀系统一样。不过抢红包一般是内部系统，不需要针对性限流。

![[image-141.png]]

### 0.1.8 数据库分库分表优化
![[image-142.png]]

### 0.1.9 打款
打款可以用消息队列异步实现。

### 0.1.10 抢红包
#### 0.1.10.1 mysql抢红包
当多个 client 抢红包时，获取该活动下所有可用的红包明细，随机返回其中一条然后再去更新，更新成功则代表用户抢到了该红包，失败则代表出现了冲突，可以循环进行重试。
因为红包明细有多个，这样冲突也降低了。

#### 0.1.10.2 Redis队列方案
选用队列串行化的方案，抢红包整个过程只会操作 Redis，且都是简单高效的 Pop 和 Push 命令操作。
抢红包流程：先从红包队列中 **Pop** **占有红包**，然后 Push 红包到消息队列（待异步打款处理），并同步告知用户抢到红包的结果，抢红包流程就结束了。

当然，在实际应用中，占有红包过程中还会有一些前置规则校验，比如用户是否已经领取过，领取次数是否已经达到上限等？红包占有流程图如下：
![[image-136.png]]
使用lua脚本保证抢红包的原子性。

---

---
# 1 引用