2025-10-31 10:54
Status: #idea
Tags:

# 1 数据分片方式
数据分片就是按照一定的规则，将数据集划分成相互独立正交的数据子集。然后将数据子集分布到不同的节点上，通过设计合理的数据分片规则，可将系统中的数据分布在不同的物理数据库中，达到提升应用系统数据处理速度的目的。
一般来讲，分片算法常见的就是 `Hash` 分片、一致性 `Hash` 分片和按照范围数据分片三种。我们以缓存为例子。

## 1.1 Hash分片
`Hash` 分片的算法就是对缓存的 `Key` 做哈希计算，然后对总的缓存节点个数取余。这个算法最大的优点就是简单易理解，缺点是当增加或者减少缓存节点时，缓存总的节点个数变化造成计算出来的节点发生变化，从而造成缓存失效不可用。
所以我建议你，如果采用这种方法，最好建立在你对于这组缓存命中率下降不敏感，比如下面还有另外一层缓存来兜底的情况下。

## 1.2 一致性Hash分片
用一致性 `Hash` 算法可以很好地解决增加和删减节点时，命中率下降的问题。
在这个算法中，我们将整个 `Hash` 值空间组织成一个虚拟的圆环，然后将缓存节点的 `IP` 地址或者主机名做 `Hash` 取值后，放置在这个圆环上。当我们需要确定某一个 `Key` 需要存取到哪个节点上的时候，先对这个 `Key` 做同样的 Hash 取值，确定在环上的位置，然后按照顺时针方向在环上“行走”，遇到的第一个缓存节点就是要访问的节点。
比方说下面这张图里面，`Key 1` 和 `Key 2` 会落入到 `Node 1` 中，`Key 3`、`Key 4` 会落入到 `Node 2` 中，`Key 5` 落入到 `Node 3` 中，`Key 6` 落入到 `Node 4` 中。
![[image-173.png]]

这时如果在 `Node 1` 和 `Node 2` 之间增加一个 `Node 5`，你可以看到原本命中 `Node 2` 的 `Key 3` 现在命中到 `Node 5`，而其它的 `Key` 都没有变化；同样的道理，如果我们把 `Node 3` 从集群中移除，那么只会影响到 `Key 5` 。所以你看，在增加和删除节点时，只有少量的 `Key` 会 **漂移** 到其它节点上，而大部分的 `Key` 命中的节点还是会保持不变，从而可以保证命中率不会大幅下降。
![[image-174.png]]

不过，事物总有两面性。虽然这个算法对命中率的影响比较小，但它还是存在问题：
- 缓存节点在圆环上分布不平均，会造成部分缓存节点的压力较大；
- 当某个节点故障时，这个节点所要承担的所有访问都会被顺移到另一个节点上，会对后面这个节点造成压力。

极端情况下，比如一个有三个节点 `A、B、C` 承担整体的访问，每个节点的访问量平均，`A` 故障后，`B` 将承担双倍的压力（A 和 B 的全部请求），当 `B` 承担不了流量 `Crash` 后，`C` 也将因为要承担原先三倍的流量而 `Crash`，这就造成了整体缓存系统的雪崩。
你可以在一致性 `Hash` 算法中引入**虚拟节点**的概念。**它将一个缓存节点计算多个 `Hash` 值分散到圆环的不同位置，这样既实现了数据的平均**，而且当某一个节点故障或者退出的时候，它原先承担的 `Key` 将以更加平均的方式分配到其他节点上，从而避免雪崩的发生。

### 1.2.1 一致性 Hash 算法的脏数据问题
为什么会产生脏数据呢？ 比方说，在集群中有两个节点 `A` 和 `B`，客户端初始写入一个 `Key` 为 k，值为 `3` 的缓存数据到 `Cache A` 中。这时如果要更新 `k` 的值为 `4`，但是缓存 `A` 恰好和客户端连接出现了问题，那这次写入请求会写入到 `Cache B` 中。接下来缓存 `A` 和客户端的连接恢复，当客户端要获取 `k` 的值时，就会获取到存在 `Cache A` 中的脏数据 3，而不是 `Cache B` 中的 `4`。
所以，**在使用一致性 `Hash` 算法时一定要设置缓存的过期时间，这样当发生漂移时，之前存储的脏数据可能已经过期，就可以减少存在脏数据的几率**。

## 1.3 按照数据范围分片
常见场景就是按照 `时间区间` 或 `ID区间` 来切分。例如：按日期将不同月甚至是日的数据分散到不同的库中；将 `userId` 为 `1~9999` 的记录分到第一个库， `10000~20000` 的分到第二个库，以此类推。
某种意义上，某些系统中使用的 **"冷热数据分离"** ，将一些使用较少的历史数据迁移到其他库中，业务功能上只提供热点数据的查询，也是类似的实践。

这样的优点在于：
- 单表大小可控
- 天然便于水平扩展，后期如果想对整个分片集群扩容时，只需要添加节点即可，无需对其他分片的数据进行迁移
- 使用分片字段进行范围查找时，连续分片可快速定位分片进行快速查询，有效避免跨分片查询的问题。

缺点：
- 热点数据成为性能瓶颈。连续分片可能存在数据热点，例如按时间字段分片，有些分片存储最近时间段内的数据，可能会被频繁的读写，而有些分片存储的历史数据，则很少被查询

---
# 2 引用